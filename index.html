<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆçº¦äº¤æ˜“åˆ†æç»ˆç«¯ v5.7 (é€»è¾‘ç»ˆæä¿®å¤ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        /* Simple modal styles */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); display: flex;
            justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background-color: white; padding: 2rem; border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto;
        }
        .search-input {
             width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0;
             border-radius: 0.375rem; margin-bottom: 1rem;
        }
        /* Style for reversed logs */
        .reversed-log {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        .report-text {
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            background-color: #f3f4f6;
            padding: 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            color: #1f2937;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 md:p-6">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">åˆçº¦äº¤æ˜“åˆ†æç»ˆç«¯ v5.7</h1>
            <p class="text-gray-600 mt-2">ç»ˆæä¿®å¤ç‰ˆï¼šStrip æ›²çº¿ä»·ç²¾å‡†åŒ¹é… + æ‰¹é‡å¯¼å…¥æ€§èƒ½ä¼˜åŒ–</p>
        </header>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Column: Controls & Input -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- Trade Entry Form -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">è®°å½•æ–°äº¤æ˜“</h2>
                    
                    <!-- Batch Import Button -->
                    <button onclick="openBatchImportModal()" class="w-full mb-4 bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-300 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                        </svg>
                        æ™ºèƒ½æ–‡æœ¬æ‰¹é‡å¯¼å…¥
                    </button>
                    
                    <div class="relative flex py-2 items-center">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink-0 mx-4 text-gray-400 text-sm">æˆ– æ‰‹åŠ¨å½•å…¥</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>

                    <form id="trade-form" class="space-y-4">
                        <div>
                            <label for="trader" class="block text-sm font-medium text-gray-700">äº¤æ˜“å‘˜</label>
                            <select id="trader" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option>W</option><option>L</option><option>Z</option>
                            </select>
                        </div>
                        <div>
                            <label for="product" class="block text-sm font-medium text-gray-700">å“ç§</label>
                            <select id="product" onchange="updateContractOptions()" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="Brent">Brent</option><option value="Henry Hub">Henry Hub</option>
                            </select>
                        </div>
                        <div>
                            <label for="contract" class="block text-sm font-medium text-gray-700">åˆçº¦</label>
                            <select id="contract" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div>
                            <label for="trade-type" class="block text-sm font-medium text-gray-700">äº¤æ˜“ç±»å‹</label>
                            <select id="trade-type" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="regular">å¸¸è§„äº¤æ˜“ (è®¡å…¥ç›ˆäº)</option>
                                <option value="adjustment">æˆæœ¬è°ƒæ•´ (ä¼˜åŒ–æˆæœ¬)</option>
                            </select>
                        </div>
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-gray-700">æ•°é‡ (è´Ÿæ•°ä¸ºå–å‡º)</label>
                            <input type="number" id="quantity" step="0.001" placeholder="-10.000" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                        </div>
                        <div>
                            <label for="price" class="block text-sm font-medium text-gray-700">æˆäº¤ä»·æ ¼</label>
                            <input type="number" step="any" id="price" placeholder="85.500" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300">æäº¤äº¤æ˜“</button>
                    </form>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">å…¨å±€è´¹ç”¨è®¾ç½®</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="commission-brent" class="block text-sm font-medium text-gray-700">Brent è´¹ç”¨ (per barrel)</label>
                            <input type="number" step="0.01" id="commission-brent" value="0.00" onchange="updateSettings()" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="0.01">
                        </div>
                         <div>
                            <label for="commission-hh" class="block text-sm font-medium text-gray-700">Henry Hub è´¹ç”¨ (per MMBtu)</label>
                            <input type="number" step="0.0001" id="commission-hh" value="0.0000" onchange="updateSettings()" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="0.0015">
                        </div>
                        <div>
                            <label for="exchange-rate-rmb" class="block text-sm font-medium text-gray-700">é€šç”¨æ±‡ç‡ (USD to RMB)</label>
                            <input type="number" step="0.01" id="exchange-rate-rmb" value="7.13" onchange="updateSettings()" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="7.13">
                        </div>
                        <div>
                            <label for="initial-realized-pl" class="block text-sm font-medium text-gray-700">æœŸåˆå®ç°ç›ˆäº (USD)</label>
                            <input type="number" step="any" id="initial-realized-pl" value="0.00" onchange="updateSettings()" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">æƒ…æ™¯åˆ†æ / å‹åŠ›æµ‹è¯•</h2>
                    <div class="space-y-4">
                        <div>
                             <label for="brent-scenario" class="block text-sm font-medium text-gray-700">Brent ä»·æ ¼å˜åŠ¨</label>
                             <input type="number" step="any" id="brent-scenario" placeholder="+5.00" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="hh-scenario" class="block text-sm font-medium text-gray-700">Henry Hub ä»·æ ¼å˜åŠ¨</label>
                            <input type="number" step="any" id="hh-scenario" placeholder="-0.5000" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <button onclick="runStressTest()" class="w-full bg-amber-600 text-white py-2 px-4 rounded-md hover:bg-amber-700 transition">è®¡ç®—å½±å“</button>
                        <div id="stress-test-result" class="text-center p-3 bg-gray-100 rounded-md hidden">
                            <p class="font-semibold">é¢„ä¼°P/Lå˜åŠ¨: <span id="pl-change" class="text-lg"></span></p>
                            <p>é¢„ä¼°æ–°æ€»æµ®åŠ¨å‡€ç›ˆäº: <span id="new-total-pl" class="text-lg"></span></p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">æ•°æ®ç®¡ç† & æ—¥æŠ¥</h2>
                    <div class="space-y-3">
                        <button onclick="exportData()" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-300">å¯¼å‡ºå…¨éƒ¨æ•°æ® (JSON)</button>
                        <div>
                            <label for="import-file" class="w-full text-center cursor-pointer bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition duration-300 block">å¯¼å…¥æ•°æ® (JSON)</label>
                            <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(event)">
                        </div>
                        <!-- Import Market Data Only -->
                        <div>
                            <label for="import-mtm-file" class="w-full text-center cursor-pointer bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 transition duration-300 block flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                                ğŸ“ˆ å¯¼å…¥è¡Œæƒ…æ•°æ® (JSON)
                            </label>
                            <input type="file" id="import-mtm-file" class="hidden" accept=".json" onchange="importMtmData(event)">
                        </div>

                        <button onclick="exportLedgerCSV()" class="w-full bg-blue-800 text-white py-2 px-4 rounded-md hover:bg-blue-900 transition duration-300">å¯¼å‡ºé€æ—¥å°è´¦ (CSV)</button>
                        <button onclick="generateDailyReport()" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 transition duration-300 shadow-md border-l-4 border-purple-800">ğŸ“ ç”Ÿæˆä»Šæ—¥æ—¥æŠ¥æ‘˜è¦</button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Data Display & Analysis -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Scenario Analysis Module (Moved to main column for better visibility) -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="text-xl font-semibold">å½“å‰æŒä»“</h2>
                        <button onclick="exportPositionsCSV()" class="bg-gray-200 text-gray-700 py-1 px-3 rounded-md text-sm hover:bg-gray-300">å¯¼å‡ºCSV</button>
                    </div>
                    <input type="text" id="search-positions" onkeyup="filterTable('search-positions', 'positions-table')" placeholder="æœç´¢åˆçº¦/äº¤æ˜“å‘˜..." class="search-input">
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-max text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3">äº¤æ˜“å‘˜</th>
                                    <th scope="col" class="px-4 py-3">åˆçº¦</th>
                                    <th scope="col" class="px-4 py-3">æ•°é‡</th>
                                    <th scope="col" class="px-4 py-3">å‡ä»·</th>
                                    <th scope="col" class="px-4 py-3">MTMä»·æ ¼</th>
                                    <th scope="col" class="px-4 py-3">æµ®åŠ¨å‡€P/L</th>
                                    <th scope="col" class="px-4 py-3">å¯¹åº”åˆ°å²¸ä»·</th>
                                    <th scope="col" class="px-4 py-3">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="positions-table"></tbody>
                            <tfoot class="font-semibold text-gray-800 bg-gray-50">
                                <tr>
                                    <td colspan="5" class="text-right px-4 py-2">æ€»è®¡</td>
                                    <td id="total-floating-pl" class="px-4 py-2">0.00</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="text-xl font-semibold">äº¤æ˜“æ—¥å¿—</h2>
                        <button onclick="exportLogCSV()" class="bg-gray-200 text-gray-700 py-1 px-3 rounded-md text-sm hover:bg-gray-300">å¯¼å‡ºCSV</button>
                    </div>
                    <input type="text" id="search-log" onkeyup="filterTable('search-log', 'log-table')" placeholder="æœç´¢åˆçº¦/äº¤æ˜“å‘˜..." class="search-input">
                    <div class="overflow-x-auto max-h-80">
                         <table class="w-full min-w-max text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-4 py-3">æ—¶é—´</th><th scope="col" class="px-4 py-3">äº¤æ˜“å‘˜</th><th scope="col" class="px-4 py-3">åˆçº¦</th><th scope="col" class="px-4 py-3">æ•°é‡</th><th scope="col" class="px-4 py-3">ä»·æ ¼</th><th scope="col" class="px-4 py-3">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="log-table"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="text-xl font-semibold">å†å²å¹³ä»“è®°å½•</h2>
                        <button onclick="exportHistoryCSV()" class="bg-gray-200 text-gray-700 py-1 px-3 rounded-md text-sm hover:bg-gray-300">å¯¼å‡ºCSV</button>
                    </div>
                    <input type="text" id="search-history" onkeyup="filterTable('search-history', 'history-table')" placeholder="æœç´¢åˆçº¦/äº¤æ˜“å‘˜..." class="search-input">
                    <div class="overflow-x-auto max-h-80">
                         <table class="w-full min-w-max text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-4 py-3">æ—¥æœŸ</th><th scope="col" class="px-4 py-3">äº¤æ˜“å‘˜</th><th scope="col" class="px-4 py-3">åˆçº¦</th><th scope="col" class="px-4 py-3">å¹³ä»“é‡</th><th scope="col" class="px-4 py-3">å¼€ä»“ä»·</th><th scope="col" class="px-4 py-3">å¹³ä»“ä»·</th><th scope="col" class="px-4 py-3">å®ç°å‡€P/L</th>
                                </tr>
                            </thead>
                            <tbody id="history-table"></tbody>
                             <tfoot class="font-semibold text-gray-800 bg-gray-50 sticky bottom-0">
                                <tr>
                                    <td colspan="6" class="text-right px-4 py-2">ç´¯è®¡å®ç°ç›ˆäº</td>
                                    <td id="total-realized-pl" class="px-4 py-2">0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Infographics æ•°æ®åˆ†æ</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-medium text-center mb-2">æŒä»“å¸‚å€¼ç»“æ„</h3>
                            <div class="chart-container"><canvas id="position-structure-chart"></canvas></div>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-center mb-2">å·²å®ç°å‡€ç›ˆäºæ›²çº¿</h3>
                            <div class="chart-container"><canvas id="realized-pl-chart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="edit-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-xl font-semibold mb-4">ç¼–è¾‘æŒä»“</h2>
            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-index"><label class="block text-sm font-medium text-gray-700">æ•°é‡<input type="number" id="edit-quantity" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" required></label><label class="block text-sm font-medium text-gray-700">å‡ä»·<input type="number" step="any" id="edit-price" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" required></label>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeEditModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400">å–æ¶ˆ</button><button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="action-confirm-modal" class="modal-backdrop hidden">
        <div class="modal-content text-center">
            <h2 id="confirm-title" class="text-xl font-semibold mb-4"></h2>
            <p id="confirm-body" class="text-gray-600 mb-6 whitespace-pre-line"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" type="button" onclick="closeActionConfirmModal()" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-md hover:bg-gray-400">å–æ¶ˆ</button>
                <button id="confirm-action-btn" type="button" class="bg-red-600 text-white py-2 px-6 rounded-md hover:bg-red-700">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- Daily Report Modal -->
    <div id="report-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-xl font-semibold mb-4">ä»Šæ—¥æ—¥æŠ¥æ‘˜è¦</h2>
            <div id="daily-report-content" class="report-text mb-4"></div>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeReportModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400">å…³é—­</button>
                <button type="button" onclick="copyReportToClipboard()" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">å¤åˆ¶æ—¥æŠ¥</button>
            </div>
        </div>
    </div>

    <!-- Batch Import Modal -->
    <div id="batch-import-modal" class="modal-backdrop hidden">
        <div class="modal-content max-w-4xl w-full">
            <h2 class="text-xl font-semibold mb-4">æ™ºèƒ½æ–‡æœ¬æ‰¹é‡å¯¼å…¥</h2>
            <p class="text-sm text-gray-600 mb-4">
                è¯·ç²˜è´´æ‚¨çš„äº¤æ˜“è®°å½•æ–‡æœ¬ã€‚æ¯è¡Œä¸€æ¡äº¤æ˜“ã€‚<br>
                <span class="text-xs text-gray-500">ç¤ºä¾‹1: You bot 5x/m mar-Dec brt at 61.16 otc<br>
                ç¤ºä¾‹2: 61.43 61.22 ... (ç›´æ¥æ¢è¡Œè·Ÿéšæ˜ç»†ä»·æ ¼)</span>
            </p>
            
            <textarea id="batch-input" rows="10" class="w-full p-3 border border-gray-300 rounded-md font-mono text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="åœ¨æ­¤ç²˜è´´äº¤æ˜“æ–‡æœ¬..."></textarea>
            
            <div class="flex justify-end space-x-3 my-4">
                <button onclick="parseImportText()" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">è§£æé¢„è§ˆ</button>
            </div>
            
            <div id="import-preview-container" class="hidden">
                <h3 class="text-lg font-medium mb-2">è§£æç»“æœé¢„è§ˆ</h3>
                <div class="overflow-x-auto border border-gray-200 rounded-md max-h-64">
                    <table class="w-full min-w-max text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2">çŠ¶æ€</th>
                                <th class="px-4 py-2">äº¤æ˜“å‘˜</th>
                                <th class="px-4 py-2">å“ç§</th>
                                <th class="px-4 py-2">åˆçº¦</th>
                                <th class="px-4 py-2">æ–¹å‘</th>
                                <th class="px-4 py-2">æ•°é‡</th>
                                <th class="px-4 py-2">ä»·æ ¼</th>
                            </tr>
                        </thead>
                        <tbody id="import-preview-body"></tbody>
                    </table>
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <span id="import-summary" class="text-sm font-medium text-gray-700"></span>
                    <div class="space-x-3">
                        <button onclick="closeBatchImportModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400">å–æ¶ˆ</button>
                        <button onclick="batchSubmitTrades()" id="btn-batch-submit" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">ç¡®è®¤æäº¤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// --- CONFIGURATION ---
const config = {
    traders: ['W', 'L', 'Z'],
    contracts: { 'Brent': ['2602', '2603', '2604', '2605', '2606', '2607', '2608', '2609', '2610', '2611', '2612'], 'Henry Hub': ['HH2511', 'HH2512', 'HH2601'] },
    contractMultipliers: { 'Brent': 1000, 'Henry Hub': 10000 },
    colors: { 'Brent': 'rgba(59, 130, 246, 0.2)', 'Henry Hub': 'rgba(16, 185, 129, 0.2)' }
};

// --- STATE MANAGEMENT ---
let state = {
    positions: [],
    history: [],
    transactionLog: [],
    marketPrices: {},
    settings: {
        fees: {
            brentPerBbl: 0.00,
            hhPerMMBtu: 0.0000
        },
        exchangeRateRMB: 7.13,
        initialRealizedPL: 0.00
    }
};

// --- CHART INSTANCES ---
let positionChart = null; let plChart = null;

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    loadState();
    hydrateState();
    initializeUI();
    rebuildStateFromLogs(); // Ensure state is built on load
    renderAll();
    document.getElementById('trade-form').addEventListener('submit', handleTradeSubmit);
    document.getElementById('edit-form').addEventListener('submit', handleEditSubmit);
});

function initializeUI() {
    updateContractOptions();
    document.getElementById('commission-brent').value = state.settings.fees.brentPerBbl.toFixed(2);
    document.getElementById('commission-hh').value = state.settings.fees.hhPerMMBtu.toFixed(4);
    document.getElementById('exchange-rate-rmb').value = state.settings.exchangeRateRMB.toFixed(2);
    document.getElementById('initial-realized-pl').value = state.settings.initialRealizedPL.toFixed(2);
}

function hydrateState() {
    if (!state.positions || !Array.isArray(state.positions)) state.positions = [];
    if (!state.history || !Array.isArray(state.history)) state.history = [];
    if (!state.transactionLog || !Array.isArray(state.transactionLog)) state.transactionLog = [];
    if (!state.marketPrices || typeof state.marketPrices !== 'object') state.marketPrices = {};
    if (!state.settings) state.settings = {};
    if (!state.settings.fees) {
        state.settings.fees = { brentPerBbl: 0.00, hhPerMMBtu: 0.0000 };
    }
    if (!state.settings.exchangeRateRMB) {
        state.settings.exchangeRateRMB = 7.13;
    }
    if (!state.settings.initialRealizedPL) {
        state.settings.initialRealizedPL = 0.00;
    }
    state.transactionLog.forEach(log => {
        if (!log.id) log.id = new Date(log.date).getTime() + Math.random();
        if (!log.status) log.status = 'active';
        if (!log.type) log.type = 'regular';
    });
}

function updateContractOptions() {
    const product = document.getElementById('product').value;
    const contractSelect = document.getElementById('contract');
    contractSelect.innerHTML = config.contracts[product].map(c => `<option value="${c}">${c}</option>`).join('');
    document.getElementById('price').placeholder = product === 'Henry Hub' ? '2.8500' : '85.500';
}

// --- UTILITY FUNCTIONS ---
function getPricePrecision(product) { return product === 'Henry Hub' ? 4 : 2; }
function formatPrice(price, product) { if (typeof price !== 'number') return 'N/A'; return price.toFixed(getPricePrecision(product)); }
function updateMtmPrice(key, newPriceStr) { const newPrice = parseFloat(newPriceStr); if (isNaN(newPrice)) return; const position = state.positions.find(p => p.key === key); if (position) { state.marketPrices[position.contract] = newPrice; saveState(); renderPositionsTable(); } }
function saveState() { localStorage.setItem('tradeAppState', JSON.stringify(state)); }
function loadState() { const s = localStorage.getItem('tradeAppState'); if (s) state = JSON.parse(s); }
function formatDateForExport(isoString, includeTime = true) { const date = new Date(isoString); const YYYY = date.getFullYear(); const MM = String(date.getMonth() + 1).padStart(2, '0'); const DD = String(date.getDate()).padStart(2, '0'); if (!includeTime) return `${YYYY}-${MM}-${DD}`; const hh = String(date.getHours()).padStart(2, '0'); const mm = String(date.getMinutes()).padStart(2, '0'); const ss = String(date.getSeconds()).padStart(2, '0'); return `${YYYY}-${MM}-${DD} ${hh}:${mm}:${ss}`; }
function filterTable(inputId, tableBodyId) { const input = document.getElementById(inputId); if (!input) return; const searchTerm = input.value.toLowerCase(); const tableBody = document.getElementById(tableBodyId); const rows = tableBody.getElementsByTagName('tr'); for (let i = 0; i < rows.length; i++) { if (rows[i].textContent.includes('å°è®¡')) { rows[i].style.display = ""; continue; } const rowText = rows[i].textContent.toLowerCase(); rows[i].style.display = rowText.includes(searchTerm) ? "" : "none"; } }

// --- MODAL HELPER FUNCTIONS ---
function openConfirmModal(title, body, onConfirm) {
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-body').textContent = body;
    document.getElementById('confirm-action-btn').onclick = onConfirm;
    document.getElementById('confirm-cancel-btn').classList.remove('hidden');
    document.getElementById('confirm-action-btn').classList.remove('hidden');
    document.getElementById('action-confirm-modal').classList.remove('hidden');
}

function openInfoModal(title, body) {
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-body').textContent = body;
    const actionBtn = document.getElementById('confirm-action-btn');
    actionBtn.textContent = 'å¥½çš„';
    actionBtn.onclick = closeActionConfirmModal;
    document.getElementById('confirm-cancel-btn').classList.add('hidden');
    actionBtn.classList.remove('hidden');
    document.getElementById('action-confirm-modal').classList.remove('hidden');
}

function closeActionConfirmModal() {
    document.getElementById('action-confirm-modal').classList.add('hidden');
    const actionBtn = document.getElementById('confirm-action-btn');
    actionBtn.textContent = 'ç¡®è®¤';
    document.getElementById('confirm-cancel-btn').classList.remove('hidden');
}

// --- MODAL CONTROLS (Edit) ---
function openEditModal(index) {
    document.getElementById('edit-index').value = index;
    document.getElementById('edit-modal').classList.remove('hidden');
}
function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }

// --- RESTORED FUNCTIONS (Missing in v5.4) ---
function updateSettings() {
    state.settings.fees.brentPerBbl = parseFloat(document.getElementById('commission-brent').value) || 0;
    state.settings.fees.hhPerMMBtu = parseFloat(document.getElementById('commission-hh').value) || 0;
    state.settings.exchangeRateRMB = parseFloat(document.getElementById('exchange-rate-rmb').value) || 7.13;
    state.settings.initialRealizedPL = parseFloat(document.getElementById('initial-realized-pl').value) || 0;
    rebuildStateFromLogs();
    saveState();
    renderAll();
}

function runStressTest() {
    const brentChange = parseFloat(document.getElementById('brent-scenario').value) || 0;
    const hhChange = parseFloat(document.getElementById('hh-scenario').value) || 0;
    let hypotheticalTotalPL = 0; let currentTotalPL = 0;
    state.positions.forEach(pos => {
        const avgPrice = pos.quantity !== 0 ? pos.totalValue / pos.quantity : 0;
        const currentPrice = state.marketPrices[pos.contract] || avgPrice;
        
        const currentGrossPL = (currentPrice * pos.quantity * config.contractMultipliers[pos.product]) - (pos.totalValue * config.contractMultipliers[pos.product]);

        const feePerUnit = pos.product === 'Brent' ? state.settings.fees.brentPerBbl : state.settings.fees.hhPerMMBtu;
        const totalVolume = Math.abs(pos.quantity) * config.contractMultipliers[pos.product];
        const commissionCost = totalVolume * feePerUnit;
        currentTotalPL += currentGrossPL - commissionCost;

        const priceChange = pos.product === 'Brent' ? brentChange : hhChange;
        const hypotheticalPrice = currentPrice + priceChange;
        const hypotheticalGrossPL = (hypotheticalPrice * pos.quantity * config.contractMultipliers[pos.product]) - (pos.totalValue * config.contractMultipliers[pos.product]);
        hypotheticalTotalPL += hypotheticalGrossPL - commissionCost;
    });
    const plChange = hypotheticalTotalPL - currentTotalPL;
    document.getElementById('pl-change').textContent = plChange.toFixed(2);
    document.getElementById('pl-change').className = `text-lg font-bold ${plChange >= 0 ? 'text-green-600' : 'text-red-600'}`;
    document.getElementById('new-total-pl').textContent = hypotheticalTotalPL.toFixed(2);
    document.getElementById('new-total-pl').className = `text-lg font-bold ${hypotheticalTotalPL >= 0 ? 'text-green-600' : 'text-red-600'}`;
    document.getElementById('stress-test-result').classList.remove('hidden');
}

function reverseTrade(logId) {
    const logToReverse = state.transactionLog.find(log => log.id === logId);
    if (!logToReverse || logToReverse.status === 'reversed') return;

    const confirmTitle = 'ç¡®è®¤æ’¤é”€äº¤æ˜“';
    const confirmBody = `æ‚¨ç¡®å®šè¦æ’¤é”€è¿™ç¬”äº¤æ˜“å—ï¼Ÿ\næ—¶é—´: ${new Date(logToReverse.date).toLocaleString()}\nåˆçº¦: ${logToReverse.contract}\næ•°é‡: ${logToReverse.quantity.toFixed(3)}\nä»·æ ¼: ${formatPrice(logToReverse.price, logToReverse.product)}`;
    
    openConfirmModal(confirmTitle, confirmBody, () => executeReverse(logId));
}

function executeReverse(logId) {
    const logToReverse = state.transactionLog.find(log => log.id === logId);
    if (logToReverse) {
        logToReverse.status = 'reversed';
        rebuildStateFromLogs(); 
        saveState();
        renderAll();
    }
    closeActionConfirmModal();
}

function handleDeleteClick() {
    const title = 'æ“ä½œå·²æ›´æ–°';
    const body = 'â€œåˆ é™¤â€åŠŸèƒ½å·²è¢«æ›´å®‰å…¨çš„â€œæ’¤é”€â€åŠŸèƒ½å–ä»£ã€‚\n\nè¯·åœ¨â€œäº¤æ˜“æ—¥å¿—â€ä¸­æ‰¾åˆ°å¯¹åº”çš„å•ç¬”äº¤æ˜“è¿›è¡Œæ’¤é”€ï¼Œä»¥ç¡®ä¿æ•°æ®è´¦ç›®çš„ç»å¯¹ä¸€è‡´æ€§ã€‚';
    openInfoModal(title, body);
}

// --- CORE LOGIC ---
function handleTradeSubmit(event) {
    event.preventDefault();
    const trader = document.getElementById('trader').value, product = document.getElementById('product').value, contract = document.getElementById('contract').value;
    const quantity = parseFloat(document.getElementById('quantity').value), price = parseFloat(document.getElementById('price').value);
    const tradeType = document.getElementById('trade-type').value;

    if (isNaN(quantity) || isNaN(price) || quantity === 0) {
        openInfoModal('è¾“å…¥æ— æ•ˆ', 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡å’Œä»·æ ¼ã€‚');
        return;
    }
    
    addTransaction(trader, product, contract, quantity, price, tradeType);
    
    document.getElementById('trade-form').reset(); 
    updateContractOptions(); 
}

function addTransaction(trader, product, contract, quantity, price, tradeType) {
    const logEntry = { id: Date.now() + Math.random(), date: new Date().toISOString(), trader, product, contract, quantity, price, status: 'active', type: tradeType }; 
    state.transactionLog.push(logEntry);
    rebuildStateFromLogs();
    saveState(); 
    renderAll();
}

function handleEditSubmit(event) {
    event.preventDefault();
    openInfoModal('æ“ä½œæ— æ•ˆ', 'æ‰‹åŠ¨ç¼–è¾‘æŒä»“åŠŸèƒ½å·²è¢«ç¦ç”¨ï¼Œä»¥ä¿è¯æ•°æ®å®Œæ•´æ€§ã€‚\n\nè¯·ä½¿ç”¨â€œäº¤æ˜“æ—¥å¿—â€ä¸­çš„â€œæ’¤é”€â€åŠŸèƒ½æ¥ä¿®æ­£é”™è¯¯ï¼Œç„¶åé‡æ–°å½•å…¥æ­£ç¡®çš„äº¤æ˜“ã€‚');
    closeEditModal();
}

// --- CORE STATE CALCULATION ---
function rebuildStateFromLogs() {
    const activeLogs = state.transactionLog.filter(log => log.status === 'active');
    activeLogs.sort((a, b) => new Date(a.date) - new Date(b.date)); 

    const tempPositions = {};
    const newHistory = [];

    activeLogs.forEach(log => {
        const { trader, product, contract, quantity, price, type } = log;
        const positionKey = `${trader}-${contract}`;
        let pos = tempPositions[positionKey];

        if (!pos) {
            pos = { key: positionKey, trader, product, contract, quantity: 0, totalValue: 0 };
            tempPositions[positionKey] = pos;
        }
        
        const openAvgPrice = (pos.quantity !== 0) ? pos.totalValue / pos.quantity : 0;

        // Check if it's a closing trade
        if (pos.quantity !== 0 && Math.sign(pos.quantity) !== Math.sign(quantity)) {
            const closeQuantity = Math.min(Math.abs(pos.quantity), Math.abs(quantity));
            const positionDirection = Math.sign(pos.quantity);

            if (type === 'regular' || !type) {
                // --- REGULAR TRADE: Realize P/L ---
                const grossPL = (price - openAvgPrice) * closeQuantity * positionDirection * config.contractMultipliers[product];
                const feePerUnit = product === 'Brent' ? state.settings.fees.brentPerBbl : state.settings.fees.hhPerMMBtu;
                const totalVolume = closeQuantity * config.contractMultipliers[product];
                const commissionCost = totalVolume * 2 * feePerUnit;
                
                newHistory.push({
                    date: log.date, trader, product, contract,
                    closedQuantity: closeQuantity * positionDirection * -1, 
                    openPrice: openAvgPrice, closePrice: price,
                    realizedPL: grossPL - commissionCost
                });
                
                // Adjust totalValue based on remaining quantity
                pos.totalValue = openAvgPrice * (pos.quantity + quantity);
                pos.quantity += quantity;
            } else {
                // --- ADJUSTMENT TRADE: Adjust Cost Basis ---
                const adjustmentPL = (price - openAvgPrice) * closeQuantity * positionDirection;
                const remainingQuantity = pos.quantity + quantity;
                const totalValueBeforeAdjustment = openAvgPrice * remainingQuantity;
                
                pos.totalValue = totalValueBeforeAdjustment - adjustmentPL;
                pos.quantity = remainingQuantity;
            }
        } else {
            // --- OPENING TRADE: Add to position ---
             pos.totalValue += quantity * price;
             pos.quantity += quantity;
        }
    });

    state.positions = Object.values(tempPositions).filter(p => Math.abs(p.quantity) >= 1e-9);
    state.history = newHistory;
}

// --- BATCH IMPORT LOGIC ---
var parsedTradesBuffer = []; 

function openBatchImportModal() {
    document.getElementById('batch-input').value = '';
    document.getElementById('import-preview-container').classList.add('hidden');
    document.getElementById('batch-import-modal').classList.remove('hidden');
}

function closeBatchImportModal() {
    document.getElementById('batch-import-modal').classList.add('hidden');
    parsedTradesBuffer = [];
}

// UPDATED v5.6: Smart merging of multiline price lists
function parseImportText() {
    const text = document.getElementById('batch-input').value;
    const rawLines = text.split('\n').filter(line => line.trim() !== '');
    
    // v5.6 Feature: Merge following lines if they look like a price list
    const mergedLines = [];
    rawLines.forEach((line, i) => {
        // Regex to check if a line is composed ONLY of numbers, spaces, or dots (price list)
        // Also check if it starts with a number to avoid merging a new trade starting with quantity without keywords
        // Heuristic: If previous line exists and this line looks like "61.43 61.22...", merge it.
        const isPriceList = /^\s*(\d+(\.\d+)?(\s+|$))+/.test(line) && !/[a-zA-Z]/.test(line);
        
        if (isPriceList && mergedLines.length > 0) {
             mergedLines[mergedLines.length - 1] += " " + line;
        } else {
             mergedLines.push(line);
        }
    });

    const previewBody = document.getElementById('import-preview-body');
    previewBody.innerHTML = '';
    parsedTradesBuffer = [];
    
    let validCount = 0;

    const monthMap = { 'JAN': '01', 'FEB': '02', 'MAR': '03', 'APR': '04', 'MAY': '05', 'JUN': '06', 'JUL': '07', 'AUG': '08', 'SEP': '09', 'OCT': '10', 'NOV': '11', 'DEC': '12' };
    const numToMonthMap = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];

    mergedLines.forEach((line) => {
        const trades = parseLine(line, monthMap, numToMonthMap); 
        trades.forEach(trade => {
             parsedTradesBuffer.push(trade);
             if (trade.isValid) validCount++;

             const row = document.createElement('tr');
             row.className = 'border-b ' + (trade.isValid ? 'bg-white' : 'bg-red-50');
             row.innerHTML = `<td class="px-4 py-2 ${trade.isValid ? 'text-green-600' : 'text-red-600'} font-bold">${trade.isValid ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ'}</td><td class="px-4 py-2">${trade.trader || '-'}</td><td class="px-4 py-2">${trade.product || '-'}</td><td class="px-4 py-2">${trade.contract || '-'}</td><td class="px-4 py-2">${trade.side === 1 ? 'ä¹°å…¥' : 'å–å‡º'}</td><td class="px-4 py-2">${trade.qty ? trade.qty : '-'}</td><td class="px-4 py-2">${trade.price ? trade.price : '-'}</td>`;
             previewBody.appendChild(row);
        });
    });

    document.getElementById('import-summary').textContent = `è§£æå®Œæˆï¼šå…± ${mergedLines.length} è¡Œï¼Œæœ‰æ•ˆç”Ÿæˆ ${validCount} ç¬”äº¤æ˜“`;
    document.getElementById('btn-batch-submit').disabled = validCount === 0;
    document.getElementById('import-preview-container').classList.remove('hidden');
}

function parseLine(line, monthMap) {
    try {
        let specificPrices = [];
        // v5.5: Clean parenthetical info but try to extract prices
        const parensMatch = line.match(/\(([^)]+)\)/);
        let cleanLine = line;
        
        if (parensMatch) {
            const content = parensMatch[1];
            // If "at" inside parens, take text after
            const atSplit = content.split(/at\s+/i);
            let numbersPart = atSplit.length > 1 ? atSplit[1] : content;
            const extractedNums = numbersPart.match(/-?\d+(\.\d+)?/g);
            if (extractedNums) specificPrices = extractedNums.map(Number);
            cleanLine = line.replace(parensMatch[0], '');
        } else {
             // v5.6: If no parens but we have a strip (detected later), try to find a list of prices at the end of string
             // We do this logic later after identifying it's a strip
        }
        
        // Clean line number: "1. ", "1)", "57."
        cleanLine = cleanLine.replace(/^\s*\d+[.)\s]+/, '');
        const upperLine = cleanLine.toUpperCase();
        
        let isValid = true;
        let trader = document.getElementById('trader').value;
        let product = '', contract = '', side = 1, qty = 0, price = 0;
        const results = [];
        let matchedContractString = '';

        if (/\bW\b/.test(upperLine)) trader = 'W'; else if (/\bL\b/.test(upperLine)) trader = 'L'; else if (/\bZ\b/.test(upperLine)) trader = 'Z';
        if (/SELL|SOLD|SHORT|å–|å¹³/.test(upperLine)) side = -1; else if (/BOT|BOUGHT|BUY|LONG|ä¹°|å»º/.test(upperLine)) side = 1;

        if (/HH|HENRY|HUB/.test(upperLine)) { isHH = true; product = 'Henry Hub'; }
        else if (/BRT|BRENT/.test(upperLine) || /\b(25|26)\d{2}\b/.test(upperLine)) { isBrent = true; product = 'Brent'; }
        
        const rangeMatch = upperLine.match(/\b(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\s*(-|TO)\s*(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\b/);
        let startMonthIdx = -1, endMonthIdx = -1, singleContract = '';

        if (rangeMatch) {
            startMonthIdx = parseInt(monthMap[rangeMatch[1]]) - 1;
            endMonthIdx = parseInt(monthMap[rangeMatch[3]]) - 1;
            matchedContractString = rangeMatch[0];
            // Ensure product defaults to Brent if not found but months are present
            if (!product) product = 'Brent';
        } else {
            const hhCodeMatch = upperLine.match(/HH\d{4}/);
            const brentCodeMatch = upperLine.match(/\b(25|26)\d{2}\b/);
            // Matches FEB26, FEB 26, 26-FEB
            const monthYearMatch1 = upperLine.match(/\b(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\s*(\d{2})?\b/);
            const monthYearMatch2 = upperLine.match(/\b(\d{2})-(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\b/);

            if (hhCodeMatch) { product = 'Henry Hub'; singleContract = hhCodeMatch[0]; matchedContractString = hhCodeMatch[0]; }
            else if (brentCodeMatch) { product = 'Brent'; singleContract = brentCodeMatch[0]; matchedContractString = brentCodeMatch[0]; }
            else if (monthYearMatch2) {
                // Handle 26-Apr
                if (!product) product = 'Brent';
                const yStr = monthYearMatch2[1];
                const mStr = monthYearMatch2[2];
                singleContract = yStr + monthMap[mStr];
                matchedContractString = monthYearMatch2[0];
            } else if (monthYearMatch1) {
                // Handle Apr 26 or Apr
                if (!product) product = 'Brent';
                const mStr = monthYearMatch1[1];
                const yStr = monthYearMatch1[2] || '26';
                singleContract = yStr + monthMap[mStr];
                matchedContractString = monthYearMatch1[0];
            }
        }

        let textForNums = upperLine;
        if (matchedContractString) textForNums = textForNums.replace(matchedContractString, '');
        textForNums = textForNums.replace(/BRT|BRENT|HH|HENRY|HUB|SOLD|SELL|SHORT|BOT|BOUGHT|BUY|LONG|PM|OTC|AT|KB|LOTS?/g, '');
        const numbers = textForNums.match(/-?\d+(\.\d+)?/g);
        
        if (numbers && numbers.length >= 1) {
            const nums = numbers.map(Number);
            
            const qtyXMatch = upperLine.match(/(\d+(\.\d+)?)X/);
            const qtyLotsMatch = upperLine.match(/(\d+(\.\d+)?)\s*(LOTS?|KB)/);
            let foundQty = false;
            if (qtyXMatch) { qty = parseFloat(qtyXMatch[1]); foundQty = true; }
            else if (qtyLotsMatch) { qty = parseFloat(qtyLotsMatch[1]); foundQty = true; }

            const priceAtMatch = upperLine.match(/AT\s*(\d+(\.\d+)?)/);
            if (priceAtMatch) price = parseFloat(priceAtMatch[1]);

            // v5.6: If range matched and NO specific prices found yet, check if remaining numbers form the price list
            if (rangeMatch && specificPrices.length === 0) {
                 // Try to use all remaining numbers as specific prices if they look like prices
                 // Filter out the Qty first
                 let potentialPrices = nums;
                 if (foundQty) potentialPrices = nums.filter(n => Math.abs(n) !== qty);
                 
                 // If we have many numbers (e.g. > 2), assume it's a price list
                 if (potentialPrices.length > 2) {
                     specificPrices = potentialPrices.map(n => Math.abs(n));
                 }
            }

            const remainingNums = nums.filter(n => {
                if (foundQty && Math.abs(n) === qty) return false; 
                if (price !== 0 && Math.abs(n) === price) return false;
                // If we used numbers for specific prices list, don't use them for single price
                if (specificPrices.length > 0 && specificPrices.includes(Math.abs(n))) return false;
                return true;
            });

            if (remainingNums.length > 0) {
                if (!foundQty && price === 0 && remainingNums.length >= 2) {
                    const n1 = Math.abs(remainingNums[0]);
                    const n2 = Math.abs(remainingNums[1]);
                    if (product === 'Henry Hub') { if (n1 < 20 && n2 >= 10) { price = n1; qty = n2; } else { qty = n1; price = n2; } } 
                    else { if (n1 > 50) { price = n1; qty = n2; } else { qty = n1; price = n2; } }
                } else if (!foundQty && price !== 0 && remainingNums.length >= 1) { qty = Math.abs(remainingNums[0]); }
                else if (foundQty && price === 0 && remainingNums.length >= 1) { price = Math.abs(remainingNums[0]); }
            }
        }
        
        // v5.6 fix: if specific prices exist, we don't strictly need single 'price' variable populated yet
        if (qty === 0 || (price === 0 && specificPrices.length === 0)) isValid = false;

        if (rangeMatch && isValid) {
            const year = '26'; 
            const totalMonths = endMonthIdx - startMonthIdx + 1;
            
            // v5.7 Logic Fix: Smart elimination of flat price from specific price list
            // If we have exactly 1 more price than months, and one matches 'price', it's likely the flat price included in the list.
            if (specificPrices.length === totalMonths + 1 && price !== 0) {
                 const index = specificPrices.indexOf(price);
                 if (index > -1) {
                     specificPrices.splice(index, 1); 
                 }
            } else if (specificPrices.length === totalMonths + 1) {
                 // No explicit flat price found, but list is too long. Assume first one might be flat price
                 specificPrices = specificPrices.slice(1);
            }

            for (let i = 0; i < totalMonths; i++) {
                let monthCode = String(startMonthIdx + i + 1).padStart(2, '0');
                let genContract = year + monthCode;
                let finalPrice = price;
                
                if (specificPrices.length >= totalMonths) {
                    finalPrice = specificPrices[i];
                } else if (specificPrices.length > 0 && specificPrices.length < totalMonths) {
                    finalPrice = specificPrices[i] || price; 
                }

                results.push({ isValid: true, trader, product, contract: genContract, side, qty, price: finalPrice, finalQty: qty * side });
            }
        } else {
             if (!product) { isValid = false; }
             results.push({ isValid, trader, product, contract: singleContract, side, qty, price, finalQty: qty * side });
        }
        return results;
    } catch (e) { console.error("Parse error", e); return [{ isValid: false }]; }
}

function batchSubmitTrades() {
    const validTrades = parsedTradesBuffer.filter(t => t.isValid);
    if (validTrades.length === 0) return;
    validTrades.forEach(t => { addTransaction(t.trader, t.product, t.contract, t.finalQty, t.price, 'regular'); });
    openInfoModal('æ‰¹é‡å¯¼å…¥æˆåŠŸ', `æˆåŠŸå¯¼å…¥ ${validTrades.length} æ¡äº¤æ˜“è®°å½•ã€‚`);
    closeBatchImportModal();
}

// --- RENDER FUNCTIONS ---
function renderAll() {
    renderPositionsTable(); renderHistoryTable(); renderLogTable(); renderInfographics();
    filterTable('search-positions', 'positions-table');
    filterTable('search-history', 'history-table');
    filterTable('search-log', 'log-table');
}

function renderPositionsTable() {
    const tableBody = document.getElementById('positions-table'); tableBody.innerHTML = '';
    let grandTotalFloatingPL = 0;
    const positionsByProduct = state.positions.reduce((acc, pos) => { (acc[pos.product] = acc[pos.product] || []).push(pos); return acc; }, {});
    Object.keys(positionsByProduct).sort().forEach(product => {
        const positions = positionsByProduct[product].sort((a, b) => a.contract.localeCompare(b.contract));
        let subTotalQuantity = 0, subTotalFloatingPL = 0;
        positions.forEach((pos, index) => {
            const avgPrice = pos.quantity !== 0 ? pos.totalValue / pos.quantity : 0;
            const currentPrice = state.marketPrices[pos.contract] || avgPrice;
            const grossPL = (currentPrice * pos.quantity * config.contractMultipliers[product]) - (pos.totalValue * config.contractMultipliers[product]);
            const feePerUnit = product === 'Brent' ? state.settings.fees.brentPerBbl : state.settings.fees.hhPerMMBtu;
            const commissionCost = Math.abs(pos.quantity) * config.contractMultipliers[product] * feePerUnit;
            const floatingPL = grossPL - commissionCost;
            let landedPrice = 0;
            const rmbRate = state.settings.exchangeRateRMB || 7.13;
            if (product === 'Brent') landedPrice = (avgPrice * 0.134 + 0.46) * rmbRate / 28.3;
            else if (product === 'Henry Hub') landedPrice = (avgPrice * 1.15 + 4.5) * rmbRate / 28.3;
            subTotalQuantity += pos.quantity; subTotalFloatingPL += floatingPL; grandTotalFloatingPL += floatingPL;
            const row = tableBody.insertRow(); row.className = 'border-b'; row.style.backgroundColor = config.colors[pos.product];
            const priceStep = 1 / Math.pow(10, getPricePrecision(pos.product));
            row.innerHTML = `<td class="px-4 py-2">${pos.trader}</td><td class="px-4 py-2 font-medium">${pos.contract}</td><td class="px-4 py-2 ${pos.quantity > 0 ? 'text-green-600' : 'text-red-600'}">${pos.quantity.toFixed(3)}</td><td class="px-4 py-2">${formatPrice(avgPrice, pos.product)}</td><td class="px-4 py-2"><input type="number" step="${priceStep}" value="${formatPrice(currentPrice, pos.product)}" onchange="updateMtmPrice('${pos.key}', this.value)" class="w-24 bg-gray-50 border border-gray-300 rounded-md text-center py-1 focus:ring-indigo-500 focus:border-indigo-500"></td><td class="px-4 py-2 font-semibold ${floatingPL >= 0 ? 'text-green-600' : 'text-red-600'}">${floatingPL.toFixed(2)}</td><td class="px-4 py-2 text-gray-500 font-mono">${landedPrice > 0 ? landedPrice.toFixed(4) : '--'}</td><td class="px-4 py-2"><button onclick="openEditModal(${index})" class="text-blue-600 hover:underline text-xs pr-2">ç¼–è¾‘</button><button onclick="reverseTrade(${state.transactionLog.find(log => `${log.trader}-${log.contract}` === pos.key)?.id})" class="text-red-600 hover:underline text-xs">æ’¤é”€</button></td>`;
        });
        const subtotalRow = tableBody.insertRow(); subtotalRow.className = 'bg-gray-200 font-semibold text-gray-700 border-b-2 border-gray-300';
        subtotalRow.innerHTML = `<td class="px-4 py-2 text-right" colspan="2">${product} å°è®¡</td><td class="px-4 py-2 ${subTotalQuantity >= 0 ? 'text-green-700' : 'text-red-700'}">${subTotalQuantity.toFixed(3)}</td><td class="px-4 py-2">--</td><td></td><td class="px-4 py-2 ${subTotalFloatingPL >= 0 ? 'text-green-700' : 'text-red-700'}">${subTotalFloatingPL.toFixed(2)}</td><td></td><td></td>`;
    });
    const totalPLCell = document.getElementById('total-floating-pl'); totalPLCell.textContent = grandTotalFloatingPL.toFixed(2);
    totalPLCell.className = `px-4 py-2 ${grandTotalFloatingPL >= 0 ? 'text-green-600' : 'text-red-600'}`;
}

function renderHistoryTable() {
    const tableBody = document.getElementById('history-table'); tableBody.innerHTML = ''; 
    let totalRealizedPL = state.settings.initialRealizedPL || 0;
    [...state.history].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(trade => {
        totalRealizedPL += trade.realizedPL;
        const row = tableBody.insertRow(); row.className = 'border-b';
        row.innerHTML = `<td class="px-4 py-2">${new Date(trade.date).toLocaleDateString()}</td><td class="px-4 py-2">${trade.trader}</td><td class="px-4 py-2 font-medium">${trade.contract}</td><td class="px-4 py-2 ${trade.closedQuantity > 0 ? 'text-green-600' : 'text-red-600'}">${trade.closedQuantity.toFixed(3)}</td><td class="px-4 py-2">${formatPrice(trade.openPrice, trade.product)}</td><td class="px-4 py-2">${formatPrice(trade.closePrice, trade.product)}</td><td class="px-4 py-2 font-semibold ${trade.realizedPL >= 0 ? 'text-green-600' : 'text-red-600'}">${trade.realizedPL.toFixed(2)}</td>`;
    });
    const totalPLCell = document.getElementById('total-realized-pl'); totalPLCell.textContent = totalRealizedPL.toFixed(2);
    totalPLCell.className = `px-4 py-2 ${totalPLCell.textContent >= 0 ? 'text-green-600' : 'text-red-600'}`;
}
function renderLogTable() {
    const tableBody = document.getElementById('log-table'); tableBody.innerHTML = '';
    [...state.transactionLog].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(log => {
        const row = tableBody.insertRow();
        row.className = `border-b ${log.status === 'reversed' ? 'reversed-log' : ''}`;
        row.innerHTML = `<td class="px-4 py-2">${new Date(log.date).toLocaleString()}</td><td class="px-4 py-2">${log.trader}</td><td class="px-4 py-2 font-medium">${log.contract}</td><td class="px-4 py-2 ${log.quantity > 0 ? 'text-green-600' : 'text-red-600'}">${log.quantity.toFixed(3)}</td><td class="px-4 py-2">${formatPrice(log.price, log.product)}</td><td class="px-4 py-2">${log.status === 'active' ? `<button onclick="reverseTrade(${log.id})" class="text-orange-600 hover:underline text-xs">æ’¤é”€</button>` : 'å·²æ’¤é”€'}</td>`;
    });
}
function renderInfographics() { renderPositionStructureChart(); renderRealizedPLChart(); }
function renderPositionStructureChart() {
    const ctx = document.getElementById('position-structure-chart').getContext('2d');
    const data = { labels: [], datasets: [{ data: [], backgroundColor: [], borderColor: '#fff', borderWidth: 1 }] };
    const positionValues = {};
    state.positions.forEach(pos => { const avgPrice = pos.quantity !== 0 ? pos.totalValue / pos.quantity : 0; const notionalValue = Math.abs(pos.quantity * avgPrice * config.contractMultipliers[pos.product]); positionValues[pos.product] = (positionValues[pos.product] || 0) + notionalValue; });
    for (const product in positionValues) { data.labels.push(product); data.datasets[0].data.push(positionValues[product]); data.datasets[0].backgroundColor.push(config.colors[product].replace('0.2', '0.7')); }
    if (positionChart) positionChart.destroy();
    positionChart = new Chart(ctx, { type: 'pie', data, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: c => `${c.label||''}: ${new Intl.NumberFormat('en-US',{style:'currency','currency':'USD'}).format(c.parsed)}` } } } } });
}
function renderRealizedPLChart() {
    const ctx = document.getElementById('realized-pl-chart').getContext('2d');
    const sortedHistory = [...state.history].sort((a, b) => new Date(a.date) - new Date(b.date));
    let cumulativePL = state.settings.initialRealizedPL || 0; 
    const chartData = sortedHistory.map(trade => { cumulativePL += trade.realizedPL; return { x: new Date(trade.date).toLocaleDateString(), y: cumulativePL }; });
    const initialDate = sortedHistory.length > 0 ? new Date(sortedHistory[0].date) : new Date(); if (sortedHistory.length > 0) initialDate.setDate(initialDate.getDate() - 1);
    const labels = [initialDate.toLocaleDateString(), ...chartData.map(d => d.x)];
    const dataPoints = [state.settings.initialRealizedPL, ...chartData.map(d => d.y)];
    const data = { labels: labels, datasets: [{ label: 'Cumulative Realized Net P/L', data: dataPoints, fill: true, borderColor: 'rgb(75, 192, 192)', backgroundColor: 'rgba(75, 192, 192, 0.2)', tension: 0.1 }] };
    if (plChart) plChart.destroy();
    plChart = new Chart(ctx, { type: 'line', data, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: v => '$' + v.toLocaleString() } } } } });
}

// --- CSV EXPORT ---
function exportData() {
    const dataStr = JSON.stringify(state, null, 2); const blob = new Blob([dataStr], {type: "application/json"}); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `trade_data_export_${new Date().toISOString()}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href);
}
function importData(event) {
    const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
    reader.onload = e => { try { const imported = JSON.parse(e.target.result); if (imported.transactionLog) { state = imported; hydrateState(); saveState(); rebuildStateFromLogs(); renderAll(); openInfoModal('æˆåŠŸ', 'æ•°æ®å¯¼å…¥æˆåŠŸ!'); } else { openInfoModal('é”™è¯¯', 'æ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–ç‰ˆæœ¬è¿‡æ—§ã€‚'); } } catch (err) { openInfoModal('é”™è¯¯', 'è§£æå¤±è´¥: ' + err.message); } }; reader.readAsText(file); event.target.value = '';
}
function importMtmData(event) {
    const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
    reader.onload = function(e) { try { const importedData = JSON.parse(e.target.result); if (!importedData.marketPrices) throw new Error("ç¼ºå°‘ marketPrices"); const newPrices = importedData.marketPrices; let updateCount = 0; for (const [contract, price] of Object.entries(newPrices)) { state.marketPrices[contract] = parseFloat(price); updateCount++; } saveState(); renderAll(); openInfoModal('è¡Œæƒ…æ›´æ–°æˆåŠŸ', `æ›´æ–°äº† ${updateCount} ä¸ªä»·æ ¼ã€‚`); } catch (error) { openInfoModal('å¯¼å…¥å¤±è´¥', error.message); } }; reader.readAsText(file); event.target.value = '';
}
function exportToCSV(headers, dataRows, fileName) {
    const csv = [ headers.join(','), ...dataRows.map(row => headers.map(fieldName => { let cell = (row[fieldName] ?? '').toString().replace(/"/g, '""'); if (cell.search(/("|,|\n)/g) >= 0) cell = `"${cell}"`; return cell; }).join(',')) ].join('\n');
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); const url = URL.createObjectURL(blob);
    link.setAttribute("href", url); link.setAttribute("download", fileName); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
}
function exportPositionsCSV() {
    const headers = ["åˆçº¦", "æ•°é‡", "å‡ä»·", "MTMä»·æ ¼", "æµ®åŠ¨å‡€P/L", "å¯¹åº”åˆ°å²¸ä»·"]; const dataRows = [];
    const positionsByProduct = state.positions.reduce((acc, pos) => { (acc[pos.product] = acc[pos.product] || []).push(pos); return acc; }, {});
    let grandTotalQuantity = 0, grandTotalFloatingPL = 0;
    
    // v5.4: Use dynamic RMB rate
    const rmbRate = state.settings.exchangeRateRMB || 7.13;

    Object.keys(positionsByProduct).sort().forEach(product => {
        const positions = positionsByProduct[product].sort((a,b) => a.contract.localeCompare(b.contract));
        let subTotalQuantity = 0, subTotalFloatingPL = 0;
        positions.forEach(p => {
            const avgPrice = p.quantity !== 0 ? p.totalValue / p.quantity : 0;
            const currentPrice = state.marketPrices[p.contract] || avgPrice;
            const feePerUnit = p.product === 'Brent' ? state.settings.fees.brentPerBbl : p.settings.fees.hhPerMMBtu;
            const grossPL = (currentPrice * p.quantity * config.contractMultipliers[p.product]) - (p.totalValue * config.contractMultipliers[p.product]);
            const floatingPL = grossPL - (Math.abs(p.quantity) * config.contractMultipliers[p.product] * feePerUnit);
            let landedPrice = 0;
            if (p.product === 'Brent') landedPrice = (avgPrice * 0.134 + 0.46) * rmbRate / 28.3;
            else if (p.product === 'Henry Hub') landedPrice = (avgPrice * 1.15 + 4.5) * rmbRate / 28.3;
            subTotalQuantity += p.quantity; subTotalFloatingPL += floatingPL;
            dataRows.push({ "åˆçº¦": p.contract, "æ•°é‡": p.quantity.toFixed(3), "å‡ä»·": formatPrice(avgPrice, p.product), "MTMä»·æ ¼": formatPrice(currentPrice, p.product), "æµ®åŠ¨å‡€P/L": floatingPL.toFixed(2), "å¯¹åº”åˆ°å²¸ä»·": landedPrice > 0 ? landedPrice.toFixed(4) : '' });
        });
        grandTotalQuantity += subTotalQuantity; grandTotalFloatingPL += subTotalFloatingPL;
        dataRows.push({ "åˆçº¦": `${product} å°è®¡`, "æ•°é‡": subTotalQuantity.toFixed(3), "å‡ä»·": "--", "MTMä»·æ ¼": "", "æµ®åŠ¨å‡€P/L": subTotalFloatingPL.toFixed(2), "å¯¹åº”åˆ°å²¸ä»·": "" }); dataRows.push({});
    });
    dataRows.push({ "åˆçº¦": "æ€»è®¡", "æ•°é‡": grandTotalQuantity.toFixed(3), "å‡ä»·": "", "MTMä»·æ ¼": "", "æµ®åŠ¨å‡€P/L": grandTotalFloatingPL.toFixed(2), "å¯¹åº”åˆ°å²¸ä»·": "" });
    exportToCSV(headers, dataRows, "current_positions.csv");
}
function exportHistoryCSV() {
    const headers = ["æ—¥æœŸ", "äº¤æ˜“å‘˜", "åˆçº¦", "å¹³ä»“é‡", "å¼€ä»“ä»·", "å¹³ä»“ä»·", "å®ç°å‡€P/L"];
    const data = state.history.map(t => ({ "æ—¥æœŸ": new Date(t.date).toISOString().split('T')[0], "äº¤æ˜“å‘˜": t.trader, "åˆçº¦": t.contract, "å¹³ä»“é‡": t.closedQuantity.toFixed(3), "å¼€ä»“ä»·": formatPrice(t.openPrice, t.product), "å¹³ä»“ä»·": formatPrice(t.closePrice, t.product), "å®ç°å‡€P/L": t.realizedPL.toFixed(2) }));
    const totalPL = (state.settings.initialRealizedPL || 0) + state.history.reduce((acc, cur) => acc + cur.realizedPL, 0);
    data.push({}); data.push({ "å¹³ä»“ä»·": "æœŸåˆå®ç°ç›ˆäº", "å®ç°å‡€P/L": (state.settings.initialRealizedPL || 0).toFixed(2) });
    data.push({ "å¹³ä»“ä»·": "ç´¯è®¡å®ç°ç›ˆäº", "å®ç°å‡€P/L": totalPL.toFixed(2) });
    exportToCSV(headers, data, "trade_history.csv");
}
function exportLogCSV() {
    const monthMap = { '01': 'jan', '02': 'feb', '03': 'mar', '04': 'apr', '05': 'may', '06': 'jun', '07': 'jul', '08': 'aug', '09': 'sep', '10': 'oct', '11': 'nov', '12': 'dec' };
    function getContractMonth(contractCode) { if (contractCode.length === 4 && !isNaN(contractCode)) return monthMap[contractCode.substring(2, 4)] || ''; if (contractCode.startsWith('HH') && contractCode.length === 6) return monthMap[contractCode.substring(4, 6)] || ''; return ''; }
    const headers = ["æ—¶é—´", "ç¼–å·", "æˆäº¤å“ç§", "äº¤æ˜“ç±»å‹", "åˆçº¦æœˆä»½", "æˆäº¤æ•°é‡", "æˆäº¤ä»·æ ¼"];
    let transactionCounter = 1;
    const dataRows = state.transactionLog.filter(log => log.status === 'active').map(log => {
        const tempPositions = {}; 
        const positionKey = `${log.trader}-${log.contract}`;
        let calculatedTradeType = log.type === 'adjustment' ? 'æˆæœ¬è°ƒæ•´' : 'å¸¸è§„äº¤æ˜“'; 
        return { "æ—¶é—´": formatDateForExport(log.date), "ç¼–å·": transactionCounter++, "æˆäº¤å“ç§": log.product, "äº¤æ˜“ç±»å‹": calculatedTradeType, "åˆçº¦æœˆä»½": getContractMonth(log.contract), "æˆäº¤æ•°é‡": Math.abs(log.quantity), "æˆäº¤ä»·æ ¼": formatPrice(log.price, log.product) };
    });
    exportToCSV(headers, dataRows, "custom_transaction_log.csv");
}
function exportLedgerCSV() {
    const headers = ["æ—¥æœŸ", "å“ç§", "åˆçº¦", "å½“æ—¥å¼€ä»“", "å¼€ä»“å‡ä»·", "å½“æ—¥å¹³ä»“", "å¹³ä»“å‡ä»·", "æœŸæœ«æŒä»“", "æŒä»“å‡ä»·", "ç»“ç®—ä»·(MTM)", "å½“æ—¥å®ç°ç›ˆäº(USD)", "å½“æ—¥å®ç°ç›ˆäº(å…ƒ)", "æœªå¹³ä»“ç›ˆäº(USD)", "æœªå¹³ä»“ç›ˆäº(å…ƒ)"];
    const dataRows = []; const activeLogs = state.transactionLog.filter(log => log.status === 'active'); activeLogs.sort((a, b) => new Date(a.date) - new Date(b.date));
    const globalPositions = {}; const logsByDay = {};
    activeLogs.forEach(log => { const day = formatDateForExport(log.date, false); if (!logsByDay[day]) logsByDay[day] = []; logsByDay[day].push(log); });
    const rmbRate = state.settings.exchangeRateRMB || 7.13;
    Object.keys(logsByDay).sort().forEach(day => {
        const dayLogs = logsByDay[day]; const dailyActivity = {}; const dailyProductSummaries = {}; 
        const dailyTotalSummary = { openQty: 0, closeQty: 0, dayRealizedPL_USD: 0, unrealizedPL_USD: 0, realizedPL_RMB: 0, unrealizedPL_RMB: 0, finalQty: 0 };
        dayLogs.forEach(log => {
            const { product, contract, quantity, price, type } = log; const groupKey = `${product}-${contract}`;
            let pos = globalPositions[groupKey]; if (!pos) { pos = { quantity: 0, totalValue: 0, product: product, contract: contract }; globalPositions[groupKey] = pos; }
            let activity = dailyActivity[groupKey]; if (!activity) { activity = { product: product, contract: contract, openQty: 0, openValue: 0, closeQty: 0, closeValue: 0, dayRealizedPL_USD: 0 }; dailyActivity[groupKey] = activity; }
            const openAvgPrice = (pos.quantity !== 0) ? pos.totalValue / pos.quantity : 0;
            if (pos.quantity !== 0 && Math.sign(pos.quantity) !== Math.sign(quantity)) {
                const closeQuantity = Math.min(Math.abs(pos.quantity), Math.abs(quantity)); const positionDirection = Math.sign(pos.quantity);
                activity.closeQty += closeQuantity; activity.closeValue += closeQuantity * price;
                if (type === 'regular' || !type) {
                    const grossPL = (price - openAvgPrice) * closeQuantity * positionDirection * config.contractMultipliers[product];
                    const feePerUnit = product === 'Brent' ? state.settings.fees.brentPerBbl : state.settings.fees.hhPerMMBtu;
                    const commissionCost = closeQuantity * config.contractMultipliers[product] * 2 * feePerUnit;
                    activity.dayRealizedPL_USD += (grossPL - commissionCost);
                    pos.totalValue = openAvgPrice * (pos.quantity + quantity); pos.quantity += quantity;
                } else {
                    const adjustmentPL = (price - openAvgPrice) * closeQuantity * positionDirection;
                    pos.totalValue = (openAvgPrice * (pos.quantity + quantity)) - adjustmentPL; pos.quantity += quantity;
                }
            } else { activity.openQty += quantity; activity.openValue += quantity * price; pos.totalValue += quantity * price; pos.quantity += quantity; }
        });
        const relevantKeys = new Set(Object.keys(dailyActivity));
        Object.keys(globalPositions).forEach(key => { if (Math.abs(globalPositions[key].quantity) > 1e-9) relevantKeys.add(key); });
        Array.from(relevantKeys).sort().forEach(groupKey => {
            const finalPos = globalPositions[groupKey]; let activity = dailyActivity[groupKey];
            if (!activity) activity = { product: finalPos.product, contract: finalPos.contract, openQty: 0, openValue: 0, closeQty: 0, closeValue: 0, dayRealizedPL_USD: 0 };
            const openAvgPrice = activity.openQty !== 0 ? activity.openValue / Math.abs(activity.openQty) : 0;
            const closeAvgPrice = activity.closeQty !== 0 ? activity.closeValue / Math.abs(activity.closeQty) : 0;
            const finalAvgPrice = finalPos.quantity !== 0 ? finalPos.totalValue / finalPos.quantity : 0;
            const mtmPrice = state.marketPrices[activity.contract] || finalAvgPrice || 0;
            const feePerUnit = activity.product === 'Brent' ? state.settings.fees.brentPerBbl : state.settings.fees.hhPerMMBtu;
            const grossUnrealizedPL = (mtmPrice * finalPos.quantity * config.contractMultipliers[activity.product]) - (finalPos.totalValue * config.contractMultipliers[activity.product]);
            const commissionCost = Math.abs(finalPos.quantity) * config.contractMultipliers[activity.product] * feePerUnit;
            const unrealizedPL_USD = grossUnrealizedPL - commissionCost;
            const realizedPL_RMB = activity.dayRealizedPL_USD * rmbRate; const unrealizedPL_RMB = unrealizedPL_USD * rmbRate;
            dataRows.push({ "æ—¥æœŸ": day, "å“ç§": activity.product, "åˆçº¦": activity.contract, "å½“æ—¥å¼€ä»“": activity.openQty.toFixed(3), "å¼€ä»“å‡ä»·": activity.openQty !== 0 ? formatPrice(openAvgPrice, activity.product) : '--', "å½“æ—¥å¹³ä»“": activity.closeQty.toFixed(3), "å¹³ä»“å‡ä»·": activity.closeQty !== 0 ? formatPrice(closeAvgPrice, activity.product) : '--', "æœŸæœ«æŒä»“": finalPos.quantity.toFixed(3), "æŒä»“å‡ä»·": formatPrice(finalAvgPrice, activity.product), "ç»“ç®—ä»·(MTM)": formatPrice(mtmPrice, activity.product), "å½“æ—¥å®ç°ç›ˆäº(USD)": activity.dayRealizedPL_USD.toFixed(2), "å½“æ—¥å®ç°ç›ˆäº(å…ƒ)": realizedPL_RMB.toFixed(2), "æœªå¹³ä»“ç›ˆäº(USD)": unrealizedPL_USD.toFixed(2), "æœªå¹³ä»“ç›ˆäº(å…ƒ)": unrealizedPL_RMB.toFixed(2) });
            if (!dailyProductSummaries[activity.product]) dailyProductSummaries[activity.product] = { openQty: 0, closeQty: 0, dayRealizedPL_USD: 0, unrealizedPL_USD: 0, realizedPL_RMB: 0, unrealizedPL_RMB: 0, finalQty: 0 };
            const s = dailyProductSummaries[activity.product]; s.openQty += activity.openQty; s.closeQty += activity.closeQty; s.dayRealizedPL_USD += activity.dayRealizedPL_USD; s.realizedPL_RMB += realizedPL_RMB; s.unrealizedPL_USD += unrealizedPL_USD; s.unrealizedPL_RMB += unrealizedPL_RMB; s.finalQty += finalPos.quantity;
            dailyTotalSummary.openQty += activity.openQty; dailyTotalSummary.closeQty += activity.closeQty; dailyTotalSummary.dayRealizedPL_USD += activity.dayRealizedPL_USD; dailyTotalSummary.realizedPL_RMB += realizedPL_RMB; dailyTotalSummary.unrealizedPL_USD += unrealizedPL_USD; dailyTotalSummary.unrealizedPL_RMB += unrealizedPL_RMB; dailyTotalSummary.finalQty += finalPos.quantity;
        });
        Object.keys(dailyProductSummaries).sort().forEach(p => { const s = dailyProductSummaries[p]; dataRows.push({ "æ—¥æœŸ": day, "å“ç§": p, "åˆçº¦": "å½“æ—¥å“ç§å°è®¡", "å½“æ—¥å¼€ä»“": s.openQty.toFixed(3), "å¼€ä»“å‡ä»·": "--", "å½“æ—¥å¹³ä»“": s.closeQty.toFixed(3), "å¹³ä»“å‡ä»·": "--", "æœŸæœ«æŒä»“": s.finalQty.toFixed(3), "æŒä»“å‡ä»·": "--", "ç»“ç®—ä»·(MTM)": "--", "å½“æ—¥å®ç°ç›ˆäº(USD)": s.dayRealizedPL_USD.toFixed(2), "å½“æ—¥å®ç°ç›ˆäº(å…ƒ)": s.realizedPL_RMB.toFixed(2), "æœªå¹³ä»“ç›ˆäº(USD)": s.unrealizedPL_USD.toFixed(2), "æœªå¹³ä»“ç›ˆäº(å…ƒ)": s.unrealizedPL_RMB.toFixed(2) }); });
        dataRows.push({ "æ—¥æœŸ": day, "å“ç§": "å½“æ—¥åˆè®¡", "åˆçº¦": "", "å½“æ—¥å¼€ä»“": dailyTotalSummary.openQty.toFixed(3), "å¼€ä»“å‡ä»·": "--", "å½“æ—¥å¹³ä»“": dailyTotalSummary.closeQty.toFixed(3), "å¹³ä»“å‡ä»·": "--", "æœŸæœ«æŒä»“": dailyTotalSummary.finalQty.toFixed(3), "æŒä»“å‡ä»·": "--", "ç»“ç®—ä»·(MTM)": "--", "å½“æ—¥å®ç°ç›ˆäº(USD)": dailyTotalSummary.dayRealizedPL_USD.toFixed(2), "å½“æ—¥å®ç°ç›ˆäº(å…ƒ)": dailyTotalSummary.realizedPL_RMB.toFixed(2), "æœªå¹³ä»“ç›ˆäº(USD)": dailyTotalSummary.unrealizedPL_USD.toFixed(2), "æœªå¹³ä»“ç›ˆäº(å…ƒ)": dailyTotalSummary.unrealizedPL_RMB.toFixed(2) });
        dataRows.push({});
    });
    exportToCSV(headers, dataRows, "daily_ledger.csv");
}
function reverseTrade(logId) {
    const logToReverse = state.transactionLog.find(log => log.id === logId); if (!logToReverse || logToReverse.status === 'reversed') return;
    const confirmTitle = 'ç¡®è®¤æ’¤é”€äº¤æ˜“'; const confirmBody = `æ‚¨ç¡®å®šè¦æ’¤é”€è¿™ç¬”äº¤æ˜“å—ï¼Ÿ\næ—¶é—´: ${new Date(logToReverse.date).toLocaleString()}\nåˆçº¦: ${logToReverse.contract}\næ•°é‡: ${logToReverse.quantity.toFixed(3)}\nä»·æ ¼: ${formatPrice(logToReverse.price, logToReverse.product)}`;
    openConfirmModal(confirmTitle, confirmBody, () => executeReverse(logId));
}
function executeReverse(logId) { const logToReverse = state.transactionLog.find(log => log.id === logId); if (logToReverse) { logToReverse.status = 'reversed'; rebuildStateFromLogs(); saveState(); renderAll(); } closeActionConfirmModal(); }
function handleDeleteClick() { const title = 'æ“ä½œå·²æ›´æ–°'; const body = 'â€œåˆ é™¤â€åŠŸèƒ½å·²è¢«æ›´å®‰å…¨çš„â€œæ’¤é”€â€åŠŸèƒ½å–ä»£ã€‚\n\nè¯·åœ¨â€œäº¤æ˜“æ—¥å¿—â€ä¸­æ‰¾åˆ°å¯¹åº”çš„å•ç¬”äº¤æ˜“è¿›è¡Œæ’¤é”€ï¼Œä»¥ç¡®ä¿æ•°æ®è´¦ç›®çš„ç»å¯¹ä¸€è‡´æ€§ã€‚'; openInfoModal(title, body); }
</script>

</body>
</html>